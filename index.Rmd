---
title: "Phishing with SQL"
description: |
  Welcome to the website. I hope you enjoy it!
site: distill::distill_website
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(dplyr)
library(rmarkdown)
library(plotly)
library(ggplot2)
library(distill)

```


This project focuses on analyzing raw data from [this dataset](https://www.kaggle.com/datasets/mikhail1681/walmart-sales?resource=download), which tracks the weekly sales of 45 Walmart stores over 2 years! It also tracks external factors like whether the week contained a holiday, the CPI, and the unemployment rate of the region.

First, the data is cleaned using pandas as we want to make sure that this data is easy to deal with. The primary goal of cleaning is to standardize the data by rounding values and removing missing values. 

```{python import, eval=FALSE, echo=T}
import pandas as pd
df = pd.read_csv('Walmart_sales.csv', parse_dates=['Date'], dayfirst=False)

```

```{python cleaning, eval=FALSE, echo=T}
#sort by store number and then date
df.sort_values(by=['Store', 'Date'])

#standarize dates to mm-dd-yyyy
df['Date'] = pd.to_datetime(df['Date'], format='%d-%m-%Y').dt.strftime('%m-%d-%Y')

#rounding data 
df.round({'Weekly_Sales':2, 'Temperature':0, 'Fuel_Price':2, 'CPI':3, 'Unemployment':3})

#removing missing values
df.dropna

#create cleaned csv
df.to_csv('./WalmartSalesClean.csv')

```


After cleaning, the data appears like so: 

```{r load data2}
data <- read.csv("WalmartSalesClean.csv")
```

```{r general1 data}
paged_table(head(data))

```

Let's answer a few questions about the data. We'll be using SQL to clean and manipulate the data. 


1. Which holidays affect weekly sales the most?

Holidays are notorious for driving up sales as Walmart often runs promotional markdown events to incentivize purchases! 

```{r, holiday}

holidaydate <- data %>%
  filter(Store == 1 & Holiday_Flag == 1) %>%
  select(Date, Weekly_Sales) 

paged_table(holidaydate)
```

The (repeating) holidays that appear in this data are: 

- Super Bowl (Feb 9th)
- Labor Day (Sept 10th)^[Note that this data is American.] 
- Thanksgiving (Nov 26th)  
- Christmas and Hanukkah (Dec 31TH)

Using SQL: 
```{sql test1, eval=FALSE, echo=T}
ALTER TABLE WalmartSalesClean
ALTER COLUMN Holiday_Flag Int;

#filtering for holiday flags and sorting 
SELECT Date, SUM(CAST(Weekly_Sales AS FLOAT)) AS Weekly_Sales
FROM WalmartSalesClean 
WHERE Holiday_Flag='1'
GROUP BY Date
ORDER BY Weekly_Sales DESC;
```

```{r, holidayordering}
data %>% 
  filter(Holiday_Flag == 1) %>%
  select(Date, Weekly_Sales) %>%
  group_by(Date) %>%
  arrange(desc(Weekly_Sales))

```

It seems like Thanksgiving (for all stores) consistently ranks the highest amongst all the holidays! 

But, this isn't accurate enough for me -- why separate it by year and day for EVERY single store? Thankfully, all our holidays are in different months, so we can retain the month in the date column and aggregating weekly sales by the holiday. 

```{sql filterholiday, eval=FALSE, echo=T}
WITH HOLIDAYDATE AS (
SELECT SUBSTRING (DATE, 1, 2) AS Date, SUM(CAST(Weekly_Sales AS FLOAT)) AS Weekly_Sales
FROM WalmartSalesClean 
WHERE Holiday_Flag='1'
GROUP BY Date
)

#Re-aggregating by date 
SELECT Date, SUM(Weekly_Sales) AS Weekly_Sales
FROM HOLIDAYDATE
GROUP BY Date
ORDER BY Weekly_Sales DESC
```

```{r, monthholidayordering}
data %>% 
  filter(Holiday_Flag == 1) %>%
  mutate(Date = substr(Date, 1, 2)) %>%
  select(Date, Weekly_Sales) %>%
  group_by(Date) %>%
  summarize(Weekly_Sales = sum(Weekly_Sales)) %>%
  arrange(desc(Weekly_Sales))

```
Despite Thanksgiving dominating the upper echelons of highest individual store profit, it seems like people spend the most on the Super Bowl! 


# adjust so that 02 is not displayed, but sintead, superbowl, make a grpah? 

2. Which stores in the dataset have the lowest and highest unemployment rate?  What factors do you think are impacting the unemployment rate?
```{sql test2, eval=FALSE, echo=T}
WITH corrdata AS (
SELECT Store, avg(CAST(Unemployment AS decimal)) AS Unemployment, avg(CAST(Temperature AS decimal)) AS Temperature, avg(CAST(Fuel_Price AS decimal)) AS Fuel_Prices, avg(CAST(CPI AS decimal)) AS CPI, avg(CAST(Weekly_Sales AS decimal)) AS Weekly_Sales
FROM WalmartSalesClean
GROUP BY Store
/*ORDER BY Unemployment desc, Weekly_Sales 

  select(Date, Weekly_Sales) %>%
  group_by(Date) %>%
  arrange(desc(Weekly_Sales))*/

```

Pearson's correlation
```{sql test3, eval=FALSE, echo=T}
rawdata AS (
SELECT Unemployment AS x, Weekly_Sales AS y, Unemployment*Weekly_Sales AS xy, Unemployment*Unemployment AS xsquared, Weekly_Sales*Weekly_Sales AS ysquared	
FROM corrdata
),

pdata AS (
SELECT SUM(x) AS sumx, SUM(y) AS sumy, SUM(xy) as sumxy, SUM(xsquared) as sumx2, SUM(ysquared) as sumy2, COUNT(x) as n
FROM rawdata
)

SELECT (n*sumxy - sumx * sumy) / (sqrt((n*sumx2 - sumx*sumx)*(n*sumy2 - sumy*sumy))) AS "Pearson's Correlation"
FROM pdata

```

3. Is there any correlation between CPI and Weekly Sales?  How does the correlation differ when the Holiday Flag is 0 versus when the Holiday Flag is 1?
```{sql test4, eval=FALSE, echo=T}
WITH rdata AS (
SELECT CAST(ROUND(CPI, 0) AS INT) AS CPI, CAST(Weekly_Sales AS decimal) AS Weekly_Sales
FROM WalmartSalesClean
WHERE Holiday_Flag = 0
),

corrdata AS(
SELECT CPI, AVG(Weekly_Sales) AS Weekly_Sales
FROM rdata
GROUP BY CPI
/*ORDER BY CPI ASC*/
),

```

```{sql test5, eval=FALSE, echo=T}
rawdata AS (
SELECT CPI AS x, Weekly_Sales AS y, CPI*Weekly_Sales AS xy, CPI*CPI AS xsquared, Weekly_Sales*Weekly_Sales AS ysquared	
FROM corrdata
),

pdata AS (
SELECT SUM(x) AS sumx, SUM(y) AS sumy, SUM(xy) as sumxy, SUM(xsquared) as sumx2, SUM(ysquared) as sumy2, COUNT(x) as n
FROM rawdata
)

SELECT (n*sumxy - sumx * sumy) / (sqrt((n*sumx2 - sumx*sumx)*(n*sumy2 - sumy*sumy))) AS "Pearson's Correlation"
FROM pdata

```


<!-- 

- which holidays appear?  
- average weekly sales -> density graph? 
- take a look at the most and least successful store 

-->



https://docs.google.com/spreadsheets/d/1JNzGqUo9HEn5WOKftEgcm94JddOK6G3_QW-UI4sFNUY/edit#gid=0